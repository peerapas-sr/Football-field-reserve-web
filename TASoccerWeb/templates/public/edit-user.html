{% extends 'public/base.html' %}
{% block title %}เกี่ยวกับเรา{% endblock %}
{% load static %}
{% block content %}
<div class="flex justify-center items-center h-screen bg-cover bg-center" style="background-image: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url({% static 'images/test.jpg' %});">
    <!-- container -->
    <div class="p-6 shadow-lg bg-white rounded-md w-full max-w-md text-gray-700">
        <h1 class="text-3xl block text-center font-semibold">ข้อมูลของฉัน</h1>
        {% if messages %}
        {% for message in messages %}
            <div class="{% if message.tags == 'error' %}text-red-500{% else %}text-green-500{% endif %} text-center mt-2">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
        <form id="userUpdateForm" method="POST" action="{% url 'update_user' %}">
            {% csrf_token %}
            <!-- email -->
            <div>
                <div class="flex gap-2 items-baseline">
                    <h1 class="block text-base mb-1 mt-2 text-gray-700">อีเมลล์</h1>
                    <p id="email-error" class="text-base text-sm text-red-500"></p> <!-- error handle -->
                </div>
                <span id="emailText" class="text-gray-700">{{user.email}}</span>
                <input type="text" id="emailInput" name="email" value="{{user.email}}" class="hidden px-3 py-1 border rounded-lg" data-original="{{user.email}}" onchange="checkForChanges()">
                <button type="button" id="emailButton" onclick="toggleEdit('email')" class="text-blue-500 hover:underline" style="cursor: pointer;">Edit</button>
            </div>
            <!-- phonenumber -->
            <div>
                <div class="flex gap-2 items-baseline">
                    <h1 class="block text-base mb-1 mt-2 text-gray-700">เบอร์โทรศัพท์</h1>
                    <p id="phone-error" class="text-base text-sm text-red-500"></p> <!-- error handle -->
                </div>
                <span id="phoneNumText" class="text-gray-700">{{user.phone_number}}</span>
                <input type="tel" maxlength="10" id="phoneNumInput" name="phone_number" value="{{user.phone_number}}" class="hidden px-3 py-1 border rounded-lg" data-original="{{user.phone_number}}" onchange="checkForChanges()">
                <button type="button" id="phoneNumButton" onclick="toggleEdit('phoneNum')" class="text-blue-500 hover:underline" style="cursor: pointer;">Edit</button>
            </div>
            <!-- username -->
            <div>
                <div class="flex gap-2 items-baseline">
                    <h1 class="block text-base mb-1 mt-2 text-gray-700">ชื่อผู้ใช้</h1>
                    <p id="username-error" class="text-base text-sm text-red-500"></p> <!-- error handle -->
                </div>
                <span id="usernameText" class="text-gray-700">{{user.username}}</span>
                <input type="text" id="usernameInput" name="username" value="{{user.username}}" class="hidden px-3 py-1 border rounded-lg" data-original="{{user.username}}" onchange="checkForChanges()">
                <button type="button" id="usernameButton" onclick="toggleEdit('username')" class="text-blue-500 hover:underline" style="cursor: pointer;">Edit</button>
            </div>
            <!-- password -->
            <div>
                <div class="flex gap-2 items-baseline">
                    <h1 class="block text-base mb-1 mt-2 text-gray-700">รหัสผ่าน</h1>
                    <p id="password-error" class="text-base text-sm text-red-500"></p>
                    <p id="confirm-password-error" class="text-base text-sm text-red-500"></p> <!-- error handle -->
                </div>
                <span id="passwordText" class="text-gray-700">••••••••</span>
                <input type="password" id="passwordInput" name="password" value="" class="hidden px-3 py-1 border rounded-lg mb-2" onchange="checkForChanges()">
                <input type="password" id="reEnterPasswordInput" name="confirm_password" value="" class="hidden px-3 py-1 border rounded-lg" onchange="checkForChanges()">
                <button type="button" id="passwordButton" onclick="toggleEdit('password')" class="text-blue-500 hover:underline" style="cursor: pointer;">Edit</button>
            </div>
            
            <!-- Hidden field to track edited fields -->
            <input type="hidden" id="editedFields" name="edited_fields" value="">
            
            <!-- Submit button with red frame -->
            <div class="mt-4">
                <button type="submit" id="submitButton" class="w-full py-2 text-center rounded-lg transition duration-200" style="background-color:rgba(231,0,11,255); color:white; opacity: 0.5; cursor: not-allowed;" disabled>บันทึกข้อมูล</button>
            </div>
            
            <!-- Status message -->
            <div id="statusMessage" class="mt-2 text-center hidden"></div>
        </form>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
    // Track if any changes have been made
    let hasChanges = false;
    let editedFields = [];
    
    function toggleEdit(id) {
        const textElement = document.getElementById(id + "Text");
        const inputElement = document.getElementById(id + "Input");
        const buttonElement = document.getElementById(id + "Button");
        const reEnterPasswordInput = document.getElementById("reEnterPasswordInput");

        if (inputElement.classList.contains("hidden")) {
            // Switching to edit mode
            textElement.classList.add("hidden");
            inputElement.classList.remove("hidden");
            buttonElement.innerText = "Save";
            if (id === "password") {
                reEnterPasswordInput.classList.remove("hidden");
            }
            
            // Add field to edited fields list if not already included
            if (!editedFields.includes(id)) {
                editedFields.push(id);
                document.getElementById("editedFields").value = editedFields.join(',');
            }
        } else {
            // Saving changes
            if (id === "password") {
                textElement.innerText = "••••••••"; // Mask password again
                reEnterPasswordInput.classList.add("hidden");
            } else {
                textElement.innerText = inputElement.value;
            }
            textElement.classList.remove("hidden");
            inputElement.classList.add("hidden");
            buttonElement.innerText = "Edit";
            
            // Check for changes when saving field edits
            checkForChanges();
        }
    }

    // Function to check if any data has changed
    function checkForChanges() {
        const emailInput = document.getElementById("emailInput");
        const phoneInput = document.getElementById("phoneNumInput");
        const usernameInput = document.getElementById("usernameInput");
        const passwordInput = document.getElementById("passwordInput");
        
        // Check if any fields have been changed
        const emailChanged = emailInput.value !== emailInput.getAttribute("data-original");
        const phoneChanged = phoneInput.value !== phoneInput.getAttribute("data-original");
        const usernameChanged = usernameInput.value !== usernameInput.getAttribute("data-original");
        const passwordChanged = passwordInput.value.length > 0;
        
        // Update hasChanges flag
        hasChanges = emailChanged || phoneChanged || usernameChanged || passwordChanged;
        
        // Update the submit button state
        updateSubmitButton();
    }
    
    // Function to update the submit button state
    function updateSubmitButton() {
        const submitButton = document.getElementById("submitButton");
        
        if (hasChanges) {
            // Enable button if changes detected
            submitButton.disabled = false;
            submitButton.style.opacity = "1";
            submitButton.style.cursor = "pointer";
        } else {
            // Disable button if no changes
            submitButton.disabled = true;
            submitButton.style.opacity = "0.5";
            submitButton.style.cursor = "not-allowed";
        }
    }

    // Select input fields
    const username = document.getElementById("usernameInput");
    const email = document.getElementById("emailInput");
    const phone = document.getElementById("phoneNumInput");
    const password = document.getElementById("passwordInput");
    const confirmPassword = document.getElementById("reEnterPasswordInput");

    // Reusable function for validation styling
    function updateBorder(input, isValid) {
        if (isValid) {
            input.style.border = "1px solid green"; // Green border for valid input
        } else {
            input.style.border = "1px solid red"; // Red border for invalid input
        }
    }

    // Validation functions
    function validateUsername() {
        const error = document.getElementById("username-error");
        const isValid = username.value.trim().length >= 3;
        error.textContent = isValid ? "" : "ชื่อผู้ใช้ต้องมีอย่างน้อย 3 ตัวอักษร";
        updateBorder(username, isValid);
        return isValid;
    }

    function validateEmail() {
        const error = document.getElementById("email-error");
        const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        const isValid = emailPattern.test(email.value.trim());
        error.textContent = isValid ? "" : "รูปแบบอีเมลไม่ถูกต้อง";
        updateBorder(email, isValid);
        return isValid;
    }

    function validatePhone() {
        const error = document.getElementById("phone-error");
        const phonePattern = /^\d{10}$/;
        const isValid = phonePattern.test(phone.value.trim());
        error.textContent = isValid ? "" : "หมายเลขโทรศัพท์ต้องมี 10 หลัก";
        updateBorder(phone, isValid);
        return isValid;
    }

    function validatePassword() {
        const error = document.getElementById("password-error");
        // Only validate if a new password is being set
        if (password.value.length === 0) {
            error.textContent = "";
            updateBorder(password, true);
            return true;
        }
        
        const isValid = password.value.length >= 5;
        error.textContent = isValid ? "" : "รหัสผ่านต้องมีอย่างน้อย 5 ตัวอักษร";
        updateBorder(password, isValid);
        return isValid;
    }

    function validateConfirmPassword() {
        const error = document.getElementById("confirm-password-error");
        // Only validate if a new password is being set
        if (password.value.length === 0) {
            error.textContent = "";
            updateBorder(confirmPassword, true);
            return true;
        }
        
        const isValid = password.value === confirmPassword.value;
        error.textContent = isValid ? "" : "รหัสผ่านไม่ตรงกัน";
        updateBorder(confirmPassword, isValid);
        return isValid;
    }

    // Attach event listeners
    username.addEventListener("input", function() {
        validateUsername();
        checkForChanges();
    });
    
    email.addEventListener("input", function() {
        validateEmail();
        checkForChanges();
    });
    
    phone.addEventListener("input", function() {
        validatePhone();
        checkForChanges();
    });
    
    password.addEventListener("input", function() {
        validatePassword();
        checkForChanges();
    });
    
    confirmPassword.addEventListener("input", function() {
        validateConfirmPassword();
        checkForChanges();
    });
    
    // Form submission handler
    document.getElementById("userUpdateForm").addEventListener("submit", function(event) {
        event.preventDefault(); // Prevent default form submission
        
        // Validate all fields
        const isUsernameValid = validateUsername();
        const isEmailValid = validateEmail();
        const isPhoneValid = validatePhone();
        const isPasswordValid = validatePassword();
        const isConfirmPasswordValid = validateConfirmPassword();

        // Check if all validations pass
        if (isUsernameValid && isEmailValid && isPhoneValid && isPasswordValid && isConfirmPasswordValid) {
            // Make sure all edited fields have their inputs visible for form submission
            for (const field of editedFields) {
                if (field === 'email') {
                    document.getElementById("emailInput").classList.remove("hidden");
                } else if (field === 'phoneNum') {
                    document.getElementById("phoneNumInput").classList.remove("hidden");
                } else if (field === 'username') {
                    document.getElementById("usernameInput").classList.remove("hidden");
                } else if (field === 'password') {
                    document.getElementById("passwordInput").classList.remove("hidden");
                    document.getElementById("reEnterPasswordInput").classList.remove("hidden");
                }
            }
            
            // Submit the form to Django backend
            this.submit();
        } else {
            // Show error message
            const statusMessage = document.getElementById("statusMessage");
            statusMessage.textContent = "โปรดแก้ไขข้อมูลก่อนบันทึกข้อมูล";
            statusMessage.classList.remove("hidden", "text-green-500");
            statusMessage.classList.add("text-red-500");
        }
    });
    
    // Initialize the form
    window.onload = function() {
        // Initialize the button as disabled
        updateSubmitButton();
    };
</script>
{% endblock %}